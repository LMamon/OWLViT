<!--
# SPDX-FileCopyrightText: Copyright (c) 2023 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
-->

<html>
<head>

    <style>

        body {
            width: 100%;
            height: 100%;
        }

        #main_container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #logo_container {
            text-align: center;
        }

        #logo {
            height: 128px;
        }
        
        #prompt_input {
            width: 100%;
            font-size: 24px;
            margin-top: 16px;
        }

        #camera_image {
            width: 640px;
        }

        #videoElement {
            display: none;
        }

    </style>

    <script type="text/javascript">

        function jpeg_binary_to_base64(buffer){
            var base64 = btoa(new Uint8Array(buffer).reduce(function (data, byte) {
                return data + String.fromCharCode(byte);
            }, ''));
            return "data:image/jpeg;base64," + base64;
        }

        var ws = undefined
        var streaming = false

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        console.log(location.host);

        ws = new WebSocket("ws://" + location.host + "/ws");

        ws.onopen = function () {

            console.log("Connected.");

            var prompt_input = document.getElementById("prompt_input")

            function handle_prompt_change(event) {

                console.log("Sending prompt: " + event.target.value);

                if (typeof ws !== 'undefined') {
                    ws.send("prompt:" + event.target.value);
                }
            }

            prompt_input.oninput = handle_prompt_change;
        };

        ws.onclose = function () {
            console.log("Disconnected.");
        };

        ws.onmessage = function (event) {
            var camera_image = document.getElementById("camera_image");
            var reader = new FileReader();
            reader.readAsDataURL(event.data);
            reader.onloadend = function () {
                console.log("Received message.");
                camera_image.src = reader.result;
            }
        };

        async function startCamera() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.warn("WebSocket not ready");
                return;
            }
            ws.send("use_browser");
            const video = document.getElementById("videoElement");

            const stream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: false
            });

            video.srcObject = stream;
            await new Promise(resolve => {
                video.onloadedmetadata = () => resolve();
            });

            await video.play();

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            console.log("Browser camera started:", canvas.width, canvas.height);

            streaming = true;
            sendFrameLoop(video);
        }

        function sendFrameLoop(video) {
            if (!streaming || ws.readyState !== WebSocket.OPEN) return;

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(function (blob) {
                if (blob) ws.send(blob);
            }, "image/jpeg", 0.7);

            setTimeout(() => sendFrameLoop(video), 33);
        }

    </script>
</head>
<body>
    <div id="main_container">
        <h1>NanoOWL</h1>
        <img id="camera_image" src="" alt="Camera Image"/>
        <br/>
        <button id="startButton" onclick="startCamera()">Use Browser</button>
        <input id="prompt_input" type="text" placeholder="[a face [an eye, a nose]]"/>
    </div>
    <video id="videoElement" autoplay playsinline muted style="display:none;"></video>
</body>
</html>
